<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>APP Push及测试点 | zhaiworld</title>
<link rel="shortcut icon" href="https://zhaiworld.github.io//favicon.ico?v=1596458901038">
<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.css" rel="stylesheet">
<link rel="stylesheet" href="https://zhaiworld.github.io//styles/main.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/go.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            zhaiworld
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
    </div>
</nav>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    APP Push及测试点
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2020-07-06 ·
                    </time>
                    
                        <a href="https://zhaiworld.github.io/tag/wXqUqK_3d/" class="post-tags">
                            # APP
                        </a>
                    
                </div>
                <div class="post-content">
                    <h3 id="简介">简介</h3>
<p>消息推送是APP触达用户的优质渠道之一，在App开发中应用的场景是十分常见。</p>
<h3 id="ios-push-原理">iOS Push 原理</h3>
<p>iOS应用的推送大部分情况下都要依赖苹果生态提供的APNs（Apple Push Notification Service）服务。<a href="https://www.jianshu.com/p/5d83250fb5a1">扩展阅读：</a></p>
<h4 id="在线push">在线Push</h4>
<p>当用户在线（APP在前台）时，收到的状态栏的消息提醒，称为在线push。这个功能与苹果系统无关，是我们自己的APP开发的一种功能，该push与设置中是否打开“通知”无关。<br>
判断app是否在线，此处可以根据APP自身的后台策略如上一次与后台交互的时间等方法来判断APP是否在线或者离线。认为在线，会发送在线push，否则，发送离线push。<br>
在线push有以下几个特点：</p>
<ul>
<li>不需要经过苹果APNs。</li>
<li>需要自己实现长链接。</li>
<li>代码在app内部实现。</li>
</ul>
<h4 id="离线push">离线Push</h4>
<p>离线push：当APP在离线（kill掉进程、切到后台、锁屏）时，收到的消息提醒，称为离线push。离线push是需要经过苹果的APNs服务器才可以推送到某台设备的某个APP上的，这是和本地push的本质区别。push与设置中是否打开“通知”有关。<br>
收到推送后（有文字有声音），点开通知，进入APP后，才执行。<br>
主要流程为：</p>
<ol>
<li>服务器端将消息先发送到苹果的APNs</li>
<li>由苹果的APNs将消息推送到客户的设备端</li>
<li>由iOS系统将接收到的消息传递给相应的App。<br>
简而言之离线push是苹果系统的行为，与app状态无关，能够直接推送到指定手机的指定app。<br>
<strong>离线push名词解释—APNs</strong><br>
APNs：Apple Push Notification service(苹果推送通知服务)。<br>
APNs主要用于以下场景：当用户主动杀掉 APP，或者 APP 进入后台超过约定时长时，APP会被kill，这样保障了前台 APP 的流畅性，也延长了手机的使用时长，获得了较好的用户体验，但是这也意味着，服务器无法主动和用户交互（如推送实时消息等），所以苹果推出了 APNs，允许设备和服务器分别与苹果的推送通知服务器保持长连接状态。<br>
关于APNs的更新有以下几点：<br>
● iOS 8以后，APNs推送的字节是2k，iOS8以前是256字节<br>
● iOS 9以后APNs支持HTTP/2协议栈，优化长连接，具有标准的HTTP返回和管道复用技术<br>
● iOS 10以后，推送的字节是4k，APNs可根据推送消息的唯一标示符查询某条消息是否被用户阅读，可更新某一推送消息，而不用发重读的多条消息</li>
</ol>
<h4 id="本地push">本地Push</h4>
<p>本地推送和远程推送的功能是一样的，都是要提醒用户去做某些事情。但是和远程推送不同的就是本地推送是不需要设备联网的，而远程推送是必需要设备联网的，因为只有联网状态下，才能和苹果的APNs服务器建立长连接，从而推送消息。本地推送是由App自己设定的，并且发送给安装此App的这台设备，属于一对一的对应关系。比较典型的应用是闹钟类似的场景。该push与设置中是否打开“通知”有关。</p>
<h3 id="安卓push">安卓Push</h3>
<h4 id="推送实现原理">推送实现原理</h4>
<p>接下来单看看目前各大平台对于推送的架构设计。<br>
推送包括 通道，客户端，和服务端 三层架构。<br>
推送设计实现<br>
<strong>主要是两种实现方式：</strong></p>
<ol>
<li>pull （客户端主动获取）<br>
客户端固定时间主动向服务端获取信息，若有更新信息，则发送至客户端<br>
心跳：轮询时间短:耗电,耗流量。时间长，不能保证消息及时。<br>
轮询：<br>
Timer：WakeLock 让CPU 保持唤醒，耗电量很大<br>
AlarmManager：管理独立的硬件时钟RTC，可以在CPU休眠的时候正常运行。在预设的时间到达之后，唤醒CPU。这样CPU可以正常休眠，只需要任务到达之后醒来一段很短的时间。极光推送就是基于此实现的。</li>
<li>push<br>
客户端被动接受）当服务端有更新时，主动发送到客户端：<br>
主要方式有：SMS、websocket, 长连接<br>
长连接又包括三种方式：<br>
GCM：google的Gcm，容易被国内厂商阉割，而且NAT（Network AddressTranslation）容易超时，长连接无法保持，造成消息推送延迟。<br>
第三方推送：友盟、极光，腾讯信鸽<br>
自定义长连接：长连接、心跳和推送及时率。<br>
保持长连接，是消息及时的重要保证。发送心跳包，如果前台检测发送失败，则重新初始化一个socket。</li>
</ol>
<h4 id="第三方推送平台">第三方推送平台</h4>
<p>这是目前使用广泛也是比较推荐的安卓推送方案，现今主流的推送平台分为</p>
<ol>
<li>手机厂商类：小米推送、华为推送。</li>
<li>第三方平台类：友盟推送、极光推送、云巴（基于MQTT）</li>
<li>BAT大厂的平台推送：阿里云移动推送、腾讯信鸽推送、百度云推送</li>
</ol>
<h4 id="安卓与ios推送的区别">安卓与iOS推送的区别</h4>
<ul>
<li>实现方式：安卓由每个应用各自维护自身的长链接，属于应用级别；ios由ios系统自身维护1个长链接，属于系统级别</li>
<li>原理：安卓推送原理主要是push，pull的方式按需实现;ios客户端将消息推送至苹果服务器，苹果服务器通过该系统级别的长连接，推送到客户端</li>
<li>其他区别：安卓推送到达率低，属于应用级别么容易被系统杀死，维护多个长连接，耗电量高；ios 推送到达率高，长连接不容易被系统杀死，耗电量低</li>
</ul>
<h3 id="测试要点">测试要点</h3>
<ul>
<li>push到达：这是最今本功能，即push能否及时到达，并展示正常</li>
<li>点击push响应：点击push后，能够跳转到对应内容</li>
<li>不同界面打开push：点击push可以直接打开app的某个界面，在不同的界面打开push后，再点击返回可能出现问题，要关注能否正常退出push打开的界面</li>
<li>系统兼容：ios的push机制一直在更新，特别是iOS10后有较大更新，要注意是否能够兼容不同的iOS系统</li>
<li>展开界面功能是否正常：比如push展开后，可能有”收藏“，“评论”等功能，点击这些功能进行使用是否能够正常响应</li>
<li>重装app：卸载重装之后，是否会收到多条push等异常</li>
<li>切换账号：用户切换账号之后是否会出现旧的账号的push等异常</li>
<li>角标计数：理论上没收到一条新的push，角标都+1，看角标计数是否正常</li>
<li>角标消失：打开push或者app之后，角标能否正常消失</li>
<li>多端同时在线：支持多端登录的app，能否在每一端都收到push</li>
<li>游客与登录状态：有些app支持游客态登录，能否正常收到push</li>
</ul>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://zhaiworld.github.io/post/linux/" class="post-title gt-a-link">
                    Liunx
                </a>
            </div>
        

        

        
            
                <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id: location.pathname,      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

            

            
        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">有策</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/zhaiworld/" target="_blank">有策</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://zhaiworld.github.io//atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
    hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
